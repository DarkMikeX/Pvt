import subprocess
import shlex
import logging

logger = logging.getLogger(__name__)

class Exploits:
    def __init__(self, tool_paths):
        """
        tool_paths: dict with paths to tools e.g. from config.TOOL_PATHS
        """
        self.sqlmap_path = tool_paths.get("sqlmap")
        self.nuclei_path = tool_paths.get("nuclei")
        self.commix_path = tool_paths.get("commix")
        # Add others as needed

    def run_sqlmap(self, target_url, extra_args=None):
        if not self.sqlmap_path:
            logger.error("Sqlmap path not configured.")
            return False, "Sqlmap path missing"

        cmd = f"{self.sqlmap_path} -u {shlex.quote(target_url)} --batch --output-dir=./sqlmap_output"
        if extra_args:
            cmd += f" {extra_args}"

        logger.info(f"Running sqlmap command: {cmd}")

        return self._run_subprocess(cmd)

    def run_nuclei(self, target_url, template=None, extra_args=None):
        if not self.nuclei_path:
            logger.error("Nuclei path not configured.")
            return False, "Nuclei path missing"

        cmd = f"{self.nuclei_path} -u {shlex.quote(target_url)}"
        if template:
            cmd += f" -t {shlex.quote(template)}"
        if extra_args:
            cmd += f" {extra_args}"

        logger.info(f"Running nuclei command: {cmd}")

        return self._run_subprocess(cmd)

    def run_commix(self, target_url, extra_args=None):
        if not self.commix_path:
            logger.error("Commix path not configured.")
            return False, "Commix path missing"

        cmd = f"{self.commix_path} -u {shlex.quote(target_url)} --batch"
        if extra_args:
            cmd += f" {extra_args}"

        logger.info(f"Running commix command: {cmd}")

        return self._run_subprocess(cmd)

    def _run_subprocess(self, cmd):
        try:
            process = subprocess.run(
                shlex.split(cmd),
                capture_output=True,
                text=True,
                timeout=900  # 15 minutes timeout
            )
            if process.returncode == 0:
                logger.info("Command executed successfully.")
                return True, process.stdout
            else:
                logger.error(f"Error: {process.stderr}")
                return False, process.stderr
        except Exception as e:
            logger.error(f"Exception running subprocess: {e}")
            return False, str(e)
